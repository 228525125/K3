--此触发器在生产投料单自动生成时，把关联生产任务单批次反写到投料单上，但仅限于YMG产品
--DROP TRIGGER IC_SCTLD

CREATE TRIGGER IC_SCTLD ON PPBOM    
AFTER INSERT,UPDATE
AS
SET NOCOUNT ON
IF EXISTS(
	SELECT 1 FROM inserted a 
	INNER JOIN PPBOMEntry b ON a.FInterID = b.FInterID  AND b.FInterID<>0
	INNER JOIN ICMO c ON a.FICMOInterID=c.FInterID
	LEFT JOIN t_ICItem d on c.FItemID=d.FItemID
	LEFT JOIN t_ICItem e on b.FItemID=e.FItemID
	WHERE 1=1
	AND (d.FNumber in ('07.10.0006','07.10.0005','07.10.0007','07.10.0008','05.04.0118','05.04.0117','05.08.0018','05.04.0119','05.04.0120','05.04.0121'
	,'05.04.0113','05.04.0114','05.04.0115','05.04.0124','05.04.0125','05.04.0126','05.04.0127','05.04.0128','05.04.0129'
	,'05.04.0130','05.04.0131','05.04.0133','05.04.0134','05.04.0135','05.04.0136','05.04.0137','05.04.0138','05.04.0139','05.04.0140'
	,'05.04.0141','05.04.0142','05.04.0143','05.04.0144','05.04.0145','07.04.0076','07.04.0077','07.04.0078','07.04.0080','07.04.0081'
	,'07.04.0082','07.04.0083','07.04.0084','07.04.0085','07.04.0086','07.04.0087','07.04.0096','07.04.0098','05.04.0156','07.10.0003'
	)
	or
	d.FName like '%YMG%' 
	or 
	d.FModel like '%YMG%'
	)
)
BEGIN

UPDATE b SET b.FBatchNo=c.FGMPBatchNo 
FROM inserted a 
INNER JOIN PPBOMEntry b ON a.FInterID = b.FInterID  AND b.FInterID<>0
INNER JOIN ICMO c ON a.FICMOInterID=c.FInterID

END


select * from PPBOM










SELECT e.FNumber,e.FName,e.FModel,b.FBatchNo,d.FNumber,c.FGMPBatchNo 
FROM PPBOM a 
INNER JOIN PPBOMEntry b ON a.FInterID = b.FInterID  AND b.FInterID<>0
INNER JOIN ICMO c ON a.FICMOInterID=c.FInterID
LEFT JOIN t_ICItem d on c.FItemID=d.FItemID
LEFT JOIN t_ICItem e on b.FItemID=e.FItemID
WHERE 1=1
AND d.FNumber in (
'05.04.0113','05.04.0114','05.04.0115','05.04.0124','05.04.0125','05.04.0126','05.04.0127','05.04.0128','05.04.0129'
,'05.04.0130','05.04.0131','05.04.0133','05.04.0134','05.04.0135','05.04.0136','05.04.0137','05.04.0138','05.04.0139','05.04.0140'
,'05.04.0141','05.04.0142','05.04.0143','05.04.0144','05.04.0145','07.04.0076','07.04.0077','07.04.0078','07.04.0080','07.04.0081'
,'07.04.0082','07.04.0083','07.04.0084','07.04.0085','07.04.0086','07.04.0087','07.10.0003'
)


update b set b.FBatchNo=c.FGMPBatchNo FROM PPBOM a 
INNER JOIN PPBOMEntry b ON a.FInterID = b.FInterID  AND b.FInterID<>0
INNER JOIN ICMO c ON a.FICMOInterID=c.FInterID
LEFT JOIN t_ICItem d on c.FItemID=d.FItemID
LEFT JOIN t_ICItem e on b.FItemID=e.FItemID
WHERE 1=1
AND d.FNumber in ('05.04.0113','05.04.0114','05.04.0115','05.04.0124','05.04.0125','05.04.0126','05.04.0127','05.04.0128','05.04.0129'
,'05.04.0130','05.04.0131','05.04.0133','05.04.0134','05.04.0135','05.04.0136','05.04.0137','05.04.0138','05.04.0139','05.04.0140'
,'05.04.0141','05.04.0142','05.04.0143','05.04.0144','05.04.0145','07.04.0076','07.04.0077','07.04.0078','07.04.0080','07.04.0081'
,'07.04.0082','07.04.0083','07.04.0084','07.04.0085','07.04.0086','07.04.0087','07.10.0003')







select * from ICMO where FBillNo='WORK024212'
